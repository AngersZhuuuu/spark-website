
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyspark.sql &mdash; PySpark 1.2-SNAPSHOT documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.2-SNAPSHOT',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="PySpark 1.2-SNAPSHOT documentation" href="../../index.html" />
    <link rel="up" title="pyspark" href="../pyspark.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li><a href="../../index.html">PySpark 1.2-SNAPSHOT documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../pyspark.html" accesskey="U">pyspark</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pyspark.sql</h1><div class="highlight"><pre>
<span class="c">#</span>
<span class="c"># Licensed to the Apache Software Foundation (ASF) under one or more</span>
<span class="c"># contributor license agreements.  See the NOTICE file distributed with</span>
<span class="c"># this work for additional information regarding copyright ownership.</span>
<span class="c"># The ASF licenses this file to You under the Apache License, Version 2.0</span>
<span class="c"># (the &quot;License&quot;); you may not use this file except in compliance with</span>
<span class="c"># the License.  You may obtain a copy of the License at</span>
<span class="c">#</span>
<span class="c">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c"># See the License for the specific language governing permissions and</span>
<span class="c"># limitations under the License.</span>
<span class="c">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">public classes of Spark SQL:</span>

<span class="sd">    - L{SQLContext}</span>
<span class="sd">      Main entry point for SQL functionality.</span>
<span class="sd">    - L{SchemaRDD}</span>
<span class="sd">      A Resilient Distributed Dataset (RDD) with Schema information for the data contained. In</span>
<span class="sd">      addition to normal RDD operations, SchemaRDDs also support SQL.</span>
<span class="sd">    - L{Row}</span>
<span class="sd">      A Row of data returned by a Spark SQL query.</span>
<span class="sd">    - L{HiveContext}</span>
<span class="sd">      Main entry point for accessing data stored in Apache Hive..</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">keyword</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">from</span> <span class="nn">array</span> <span class="kn">import</span> <span class="n">array</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">imap</span>

<span class="kn">from</span> <span class="nn">py4j.protocol</span> <span class="kn">import</span> <span class="n">Py4JError</span>
<span class="kn">from</span> <span class="nn">py4j.java_collections</span> <span class="kn">import</span> <span class="n">ListConverter</span><span class="p">,</span> <span class="n">MapConverter</span>

<span class="kn">from</span> <span class="nn">pyspark.rdd</span> <span class="kn">import</span> <span class="n">RDD</span><span class="p">,</span> <span class="n">_load_from_socket</span>
<span class="kn">from</span> <span class="nn">pyspark.serializers</span> <span class="kn">import</span> <span class="n">BatchedSerializer</span><span class="p">,</span> <span class="n">AutoBatchedSerializer</span><span class="p">,</span> <span class="n">PickleSerializer</span><span class="p">,</span> \
    <span class="n">CloudPickleSerializer</span><span class="p">,</span> <span class="n">UTF8Deserializer</span>
<span class="kn">from</span> <span class="nn">pyspark.storagelevel</span> <span class="kn">import</span> <span class="n">StorageLevel</span>
<span class="kn">from</span> <span class="nn">pyspark.traceback_utils</span> <span class="kn">import</span> <span class="n">SCCallSiteSync</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&quot;StringType&quot;</span><span class="p">,</span> <span class="s">&quot;BinaryType&quot;</span><span class="p">,</span> <span class="s">&quot;BooleanType&quot;</span><span class="p">,</span> <span class="s">&quot;DateType&quot;</span><span class="p">,</span> <span class="s">&quot;TimestampType&quot;</span><span class="p">,</span> <span class="s">&quot;DecimalType&quot;</span><span class="p">,</span>
    <span class="s">&quot;DoubleType&quot;</span><span class="p">,</span> <span class="s">&quot;FloatType&quot;</span><span class="p">,</span> <span class="s">&quot;ByteType&quot;</span><span class="p">,</span> <span class="s">&quot;IntegerType&quot;</span><span class="p">,</span> <span class="s">&quot;LongType&quot;</span><span class="p">,</span>
    <span class="s">&quot;ShortType&quot;</span><span class="p">,</span> <span class="s">&quot;ArrayType&quot;</span><span class="p">,</span> <span class="s">&quot;MapType&quot;</span><span class="p">,</span> <span class="s">&quot;StructField&quot;</span><span class="p">,</span> <span class="s">&quot;StructType&quot;</span><span class="p">,</span>
    <span class="s">&quot;SQLContext&quot;</span><span class="p">,</span> <span class="s">&quot;HiveContext&quot;</span><span class="p">,</span> <span class="s">&quot;SchemaRDD&quot;</span><span class="p">,</span> <span class="s">&quot;Row&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">DataType</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL DataType&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">__dict__</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">typeName</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">jsonValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeName</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsonValue</span><span class="p">(),</span>
                          <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39;:&#39;</span><span class="p">),</span>
                          <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PrimitiveTypeSingleton</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Metaclass for PrimitiveType&quot;&quot;&quot;</span>

    <span class="n">_instances</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">cls</span><span class="p">]</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">PrimitiveTypeSingleton</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__call__</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">cls</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">PrimitiveType</span><span class="p">(</span><span class="n">DataType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL PrimitiveType&quot;&quot;&quot;</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">PrimitiveTypeSingleton</span>


<span class="k">class</span> <span class="nc">NullType</span><span class="p">(</span><span class="n">PrimitiveType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL NullType</span>

<span class="sd">    The data type representing None, used for the types which has not</span>
<span class="sd">    been inferred.</span>
<span class="sd">    &quot;&quot;&quot;</span>


<div class="viewcode-block" id="StringType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.StringType">[docs]</a><span class="k">class</span> <span class="nc">StringType</span><span class="p">(</span><span class="n">PrimitiveType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL StringType</span>

<span class="sd">    The data type representing string values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="BinaryType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.BinaryType">[docs]</a><span class="k">class</span> <span class="nc">BinaryType</span><span class="p">(</span><span class="n">PrimitiveType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL BinaryType</span>

<span class="sd">    The data type representing bytearray values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="BooleanType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.BooleanType">[docs]</a><span class="k">class</span> <span class="nc">BooleanType</span><span class="p">(</span><span class="n">PrimitiveType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL BooleanType</span>

<span class="sd">    The data type representing bool values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="DateType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.DateType">[docs]</a><span class="k">class</span> <span class="nc">DateType</span><span class="p">(</span><span class="n">PrimitiveType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL DateType</span>

<span class="sd">    The data type representing datetime.date values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="TimestampType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.TimestampType">[docs]</a><span class="k">class</span> <span class="nc">TimestampType</span><span class="p">(</span><span class="n">PrimitiveType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL TimestampType</span>

<span class="sd">    The data type representing datetime.datetime values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="DecimalType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.DecimalType">[docs]</a><span class="k">class</span> <span class="nc">DecimalType</span><span class="p">(</span><span class="n">DataType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL DecimalType</span>

<span class="sd">    The data type representing decimal.Decimal values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasPrecisionInfo</span> <span class="o">=</span> <span class="n">precision</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

<div class="viewcode-block" id="DecimalType.jsonValue"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.DecimalType.jsonValue">[docs]</a>    <span class="k">def</span> <span class="nf">jsonValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasPrecisionInfo</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;decimal(</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;decimal&quot;</span>
</div>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasPrecisionInfo</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;DecimalType(</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;DecimalType()&quot;</span>

</div>
<div class="viewcode-block" id="DoubleType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.DoubleType">[docs]</a><span class="k">class</span> <span class="nc">DoubleType</span><span class="p">(</span><span class="n">PrimitiveType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL DoubleType</span>

<span class="sd">    The data type representing float values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="FloatType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.FloatType">[docs]</a><span class="k">class</span> <span class="nc">FloatType</span><span class="p">(</span><span class="n">PrimitiveType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL FloatType</span>

<span class="sd">    The data type representing single precision floating-point values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="ByteType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.ByteType">[docs]</a><span class="k">class</span> <span class="nc">ByteType</span><span class="p">(</span><span class="n">PrimitiveType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL ByteType</span>

<span class="sd">    The data type representing int values with 1 singed byte.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="IntegerType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.IntegerType">[docs]</a><span class="k">class</span> <span class="nc">IntegerType</span><span class="p">(</span><span class="n">PrimitiveType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL IntegerType</span>

<span class="sd">    The data type representing int values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="LongType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.LongType">[docs]</a><span class="k">class</span> <span class="nc">LongType</span><span class="p">(</span><span class="n">PrimitiveType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL LongType</span>

<span class="sd">    The data type representing long values. If the any value is</span>
<span class="sd">    beyond the range of [-9223372036854775808, 9223372036854775807],</span>
<span class="sd">    please use DecimalType.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="ShortType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.ShortType">[docs]</a><span class="k">class</span> <span class="nc">ShortType</span><span class="p">(</span><span class="n">PrimitiveType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL ShortType</span>

<span class="sd">    The data type representing int values with 2 signed bytes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="ArrayType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.ArrayType">[docs]</a><span class="k">class</span> <span class="nc">ArrayType</span><span class="p">(</span><span class="n">DataType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL ArrayType</span>

<span class="sd">    The data type representing list values. An ArrayType object</span>
<span class="sd">    comprises two fields, elementType (a DataType) and containsNull (a bool).</span>
<span class="sd">    The field of elementType is used to specify the type of array elements.</span>
<span class="sd">    The field of containsNull is used to specify if the array has None values.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elementType</span><span class="p">,</span> <span class="n">containsNull</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates an ArrayType</span>

<span class="sd">        :param elementType: the data type of elements.</span>
<span class="sd">        :param containsNull: indicates whether the list contains None values.</span>

<span class="sd">        &gt;&gt;&gt; ArrayType(StringType()) == ArrayType(StringType(), True)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; ArrayType(StringType(), False) == ArrayType(StringType())</span>
<span class="sd">        False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elementType</span> <span class="o">=</span> <span class="n">elementType</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">containsNull</span> <span class="o">=</span> <span class="n">containsNull</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;ArrayType(</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elementType</span><span class="p">,</span>
                                     <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">containsNull</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

<div class="viewcode-block" id="ArrayType.jsonValue"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.ArrayType.jsonValue">[docs]</a>    <span class="k">def</span> <span class="nf">jsonValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeName</span><span class="p">(),</span>
                <span class="s">&quot;elementType&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementType</span><span class="o">.</span><span class="n">jsonValue</span><span class="p">(),</span>
                <span class="s">&quot;containsNull&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">containsNull</span><span class="p">}</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ArrayType.fromJson"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.ArrayType.fromJson">[docs]</a>    <span class="k">def</span> <span class="nf">fromJson</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">json</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">_parse_datatype_json_value</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="s">&quot;elementType&quot;</span><span class="p">]),</span>
                         <span class="n">json</span><span class="p">[</span><span class="s">&quot;containsNull&quot;</span><span class="p">])</span>

</div></div>
<div class="viewcode-block" id="MapType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.MapType">[docs]</a><span class="k">class</span> <span class="nc">MapType</span><span class="p">(</span><span class="n">DataType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL MapType</span>

<span class="sd">    The data type representing dict values. A MapType object comprises</span>
<span class="sd">    three fields, keyType (a DataType), valueType (a DataType) and</span>
<span class="sd">    valueContainsNull (a bool).</span>

<span class="sd">    The field of keyType is used to specify the type of keys in the map.</span>
<span class="sd">    The field of valueType is used to specify the type of values in the map.</span>
<span class="sd">    The field of valueContainsNull is used to specify if values of this</span>
<span class="sd">    map has None values.</span>

<span class="sd">    For values of a MapType column, keys are not allowed to have None values.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyType</span><span class="p">,</span> <span class="n">valueType</span><span class="p">,</span> <span class="n">valueContainsNull</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a MapType</span>
<span class="sd">        :param keyType: the data type of keys.</span>
<span class="sd">        :param valueType: the data type of values.</span>
<span class="sd">        :param valueContainsNull: indicates whether values contains</span>
<span class="sd">        null values.</span>

<span class="sd">        &gt;&gt;&gt; (MapType(StringType(), IntegerType())</span>
<span class="sd">        ...        == MapType(StringType(), IntegerType(), True))</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; (MapType(StringType(), IntegerType(), False)</span>
<span class="sd">        ...        == MapType(StringType(), FloatType()))</span>
<span class="sd">        False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyType</span> <span class="o">=</span> <span class="n">keyType</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valueType</span> <span class="o">=</span> <span class="n">valueType</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valueContainsNull</span> <span class="o">=</span> <span class="n">valueContainsNull</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;MapType(</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyType</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valueType</span><span class="p">,</span>
                                      <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valueContainsNull</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

<div class="viewcode-block" id="MapType.jsonValue"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.MapType.jsonValue">[docs]</a>    <span class="k">def</span> <span class="nf">jsonValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeName</span><span class="p">(),</span>
                <span class="s">&quot;keyType&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyType</span><span class="o">.</span><span class="n">jsonValue</span><span class="p">(),</span>
                <span class="s">&quot;valueType&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">valueType</span><span class="o">.</span><span class="n">jsonValue</span><span class="p">(),</span>
                <span class="s">&quot;valueContainsNull&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">valueContainsNull</span><span class="p">}</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="MapType.fromJson"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.MapType.fromJson">[docs]</a>    <span class="k">def</span> <span class="nf">fromJson</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">json</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MapType</span><span class="p">(</span><span class="n">_parse_datatype_json_value</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="s">&quot;keyType&quot;</span><span class="p">]),</span>
                       <span class="n">_parse_datatype_json_value</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="s">&quot;valueType&quot;</span><span class="p">]),</span>
                       <span class="n">json</span><span class="p">[</span><span class="s">&quot;valueContainsNull&quot;</span><span class="p">])</span>

</div></div>
<div class="viewcode-block" id="StructField"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.StructField">[docs]</a><span class="k">class</span> <span class="nc">StructField</span><span class="p">(</span><span class="n">DataType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL StructField</span>

<span class="sd">    Represents a field in a StructType.</span>
<span class="sd">    A StructField object comprises three fields, name (a string),</span>
<span class="sd">    dataType (a DataType) and nullable (a bool). The field of name</span>
<span class="sd">    is the name of a StructField. The field of dataType specifies</span>
<span class="sd">    the data type of a StructField.</span>

<span class="sd">    The field of nullable specifies if values of a StructField can</span>
<span class="sd">    contain None values.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataType</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a StructField</span>
<span class="sd">        :param name: the name of this field.</span>
<span class="sd">        :param dataType: the data type of this field.</span>
<span class="sd">        :param nullable: indicates whether values of this field</span>
<span class="sd">                         can be null.</span>
<span class="sd">        :param metadata: metadata of this field, which is a map from string</span>
<span class="sd">                         to simple type that can be serialized to JSON</span>
<span class="sd">                         automatically</span>

<span class="sd">        &gt;&gt;&gt; (StructField(&quot;f1&quot;, StringType(), True)</span>
<span class="sd">        ...      == StructField(&quot;f1&quot;, StringType(), True))</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; (StructField(&quot;f1&quot;, StringType(), True)</span>
<span class="sd">        ...      == StructField(&quot;f2&quot;, StringType(), True))</span>
<span class="sd">        False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataType</span> <span class="o">=</span> <span class="n">dataType</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">nullable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;StructField(</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataType</span><span class="p">,</span>
                                          <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nullable</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

<div class="viewcode-block" id="StructField.jsonValue"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.StructField.jsonValue">[docs]</a>    <span class="k">def</span> <span class="nf">jsonValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataType</span><span class="o">.</span><span class="n">jsonValue</span><span class="p">(),</span>
                <span class="s">&quot;nullable&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nullable</span><span class="p">,</span>
                <span class="s">&quot;metadata&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">}</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="StructField.fromJson"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.StructField.fromJson">[docs]</a>    <span class="k">def</span> <span class="nf">fromJson</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">json</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">StructField</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">],</span>
                           <span class="n">_parse_datatype_json_value</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]),</span>
                           <span class="n">json</span><span class="p">[</span><span class="s">&quot;nullable&quot;</span><span class="p">],</span>
                           <span class="n">json</span><span class="p">[</span><span class="s">&quot;metadata&quot;</span><span class="p">])</span>

</div></div>
<div class="viewcode-block" id="StructType"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.StructType">[docs]</a><span class="k">class</span> <span class="nc">StructType</span><span class="p">(</span><span class="n">DataType</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Spark SQL StructType</span>

<span class="sd">    The data type representing rows.</span>
<span class="sd">    A StructType object comprises a list of L{StructField}.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a StructType</span>

<span class="sd">        &gt;&gt;&gt; struct1 = StructType([StructField(&quot;f1&quot;, StringType(), True)])</span>
<span class="sd">        &gt;&gt;&gt; struct2 = StructType([StructField(&quot;f1&quot;, StringType(), True)])</span>
<span class="sd">        &gt;&gt;&gt; struct1 == struct2</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; struct1 = StructType([StructField(&quot;f1&quot;, StringType(), True)])</span>
<span class="sd">        &gt;&gt;&gt; struct2 = StructType([StructField(&quot;f1&quot;, StringType(), True),</span>
<span class="sd">        ...                       StructField(&quot;f2&quot;, IntegerType(), False)])</span>
<span class="sd">        &gt;&gt;&gt; struct1 == struct2</span>
<span class="sd">        False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&quot;StructType(List(</span><span class="si">%s</span><span class="s">))&quot;</span> <span class="o">%</span>
                <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">))</span>

<div class="viewcode-block" id="StructType.jsonValue"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.StructType.jsonValue">[docs]</a>    <span class="k">def</span> <span class="nf">jsonValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">typeName</span><span class="p">(),</span>
                <span class="s">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">jsonValue</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">]}</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="StructType.fromJson"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.StructType.fromJson">[docs]</a>    <span class="k">def</span> <span class="nf">fromJson</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">json</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">StructType</span><span class="p">([</span><span class="n">StructField</span><span class="o">.</span><span class="n">fromJson</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">json</span><span class="p">[</span><span class="s">&quot;fields&quot;</span><span class="p">]])</span>

</div></div>
<span class="k">class</span> <span class="nc">UserDefinedType</span><span class="p">(</span><span class="n">DataType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :: WARN: Spark Internal Use Only ::</span>
<span class="sd">    SQL User-Defined Type (UDT).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">typeName</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">sqlType</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Underlying SQL storage type for this UDT.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;UDT must implement sqlType().&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">module</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The Python module of the UDT.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;UDT must implement module().&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">scalaUDT</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The class name of the paired Scala UDT.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;UDT must have a paired Scala UDT.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the a user-type object into a SQL datum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;UDT must implement serialize().&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a SQL datum into a user-type object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;UDT must implement deserialize().&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsonValue</span><span class="p">(),</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39;:&#39;</span><span class="p">),</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">jsonValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;udt&quot;</span><span class="p">,</span>
            <span class="s">&quot;class&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalaUDT</span><span class="p">(),</span>
            <span class="s">&quot;pyClass&quot;</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">(),</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">),</span>
            <span class="s">&quot;sqlType&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlType</span><span class="p">()</span><span class="o">.</span><span class="n">jsonValue</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">schema</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromJson</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">json</span><span class="p">):</span>
        <span class="n">pyUDT</span> <span class="o">=</span> <span class="n">json</span><span class="p">[</span><span class="s">&quot;pyClass&quot;</span><span class="p">]</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">pyUDT</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">pyModule</span> <span class="o">=</span> <span class="n">pyUDT</span><span class="p">[:</span><span class="n">split</span><span class="p">]</span>
        <span class="n">pyClass</span> <span class="o">=</span> <span class="n">pyUDT</span><span class="p">[</span><span class="n">split</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">pyModule</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="n">pyClass</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">UDT</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">pyClass</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">UDT</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>


<span class="n">_all_primitive_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">v</span><span class="o">.</span><span class="n">typeName</span><span class="p">(),</span> <span class="n">v</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span>
                            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="n">PrimitiveTypeSingleton</span> <span class="ow">and</span>
                            <span class="n">v</span><span class="o">.</span><span class="n">__base__</span> <span class="o">==</span> <span class="n">PrimitiveType</span><span class="p">)</span>


<span class="n">_all_complex_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">v</span><span class="o">.</span><span class="n">typeName</span><span class="p">(),</span> <span class="n">v</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ArrayType</span><span class="p">,</span> <span class="n">MapType</span><span class="p">,</span> <span class="n">StructType</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_parse_datatype_json_string</span><span class="p">(</span><span class="n">json_string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses the given data type JSON string.</span>

<span class="sd">    &gt;&gt;&gt; import pickle</span>
<span class="sd">    &gt;&gt;&gt; LongType() == pickle.loads(pickle.dumps(LongType()))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; def check_datatype(datatype):</span>
<span class="sd">    ...     scala_datatype = sqlCtx._ssql_ctx.parseDataType(datatype.json())</span>
<span class="sd">    ...     python_datatype = _parse_datatype_json_string(scala_datatype.json())</span>
<span class="sd">    ...     return datatype == python_datatype</span>
<span class="sd">    &gt;&gt;&gt; all(check_datatype(cls()) for cls in _all_primitive_types.values())</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; # Simple ArrayType.</span>
<span class="sd">    &gt;&gt;&gt; simple_arraytype = ArrayType(StringType(), True)</span>
<span class="sd">    &gt;&gt;&gt; check_datatype(simple_arraytype)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; # Simple MapType.</span>
<span class="sd">    &gt;&gt;&gt; simple_maptype = MapType(StringType(), LongType())</span>
<span class="sd">    &gt;&gt;&gt; check_datatype(simple_maptype)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; # Simple StructType.</span>
<span class="sd">    &gt;&gt;&gt; simple_structtype = StructType([</span>
<span class="sd">    ...     StructField(&quot;a&quot;, DecimalType(), False),</span>
<span class="sd">    ...     StructField(&quot;b&quot;, BooleanType(), True),</span>
<span class="sd">    ...     StructField(&quot;c&quot;, LongType(), True),</span>
<span class="sd">    ...     StructField(&quot;d&quot;, BinaryType(), False)])</span>
<span class="sd">    &gt;&gt;&gt; check_datatype(simple_structtype)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; # Complex StructType.</span>
<span class="sd">    &gt;&gt;&gt; complex_structtype = StructType([</span>
<span class="sd">    ...     StructField(&quot;simpleArray&quot;, simple_arraytype, True),</span>
<span class="sd">    ...     StructField(&quot;simpleMap&quot;, simple_maptype, True),</span>
<span class="sd">    ...     StructField(&quot;simpleStruct&quot;, simple_structtype, True),</span>
<span class="sd">    ...     StructField(&quot;boolean&quot;, BooleanType(), False),</span>
<span class="sd">    ...     StructField(&quot;withMeta&quot;, DoubleType(), False, {&quot;name&quot;: &quot;age&quot;})])</span>
<span class="sd">    &gt;&gt;&gt; check_datatype(complex_structtype)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; # Complex ArrayType.</span>
<span class="sd">    &gt;&gt;&gt; complex_arraytype = ArrayType(complex_structtype, True)</span>
<span class="sd">    &gt;&gt;&gt; check_datatype(complex_arraytype)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; # Complex MapType.</span>
<span class="sd">    &gt;&gt;&gt; complex_maptype = MapType(complex_structtype,</span>
<span class="sd">    ...                           complex_arraytype, False)</span>
<span class="sd">    &gt;&gt;&gt; check_datatype(complex_maptype)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; check_datatype(ExamplePointUDT())</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; structtype_with_udt = StructType([StructField(&quot;label&quot;, DoubleType(), False),</span>
<span class="sd">    ...                                   StructField(&quot;point&quot;, ExamplePointUDT(), False)])</span>
<span class="sd">    &gt;&gt;&gt; check_datatype(structtype_with_udt)</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_parse_datatype_json_value</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_string</span><span class="p">))</span>


<span class="n">_FIXED_DECIMAL</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;decimal</span><span class="se">\\</span><span class="s">((</span><span class="se">\\</span><span class="s">d+),(</span><span class="se">\\</span><span class="s">d+)</span><span class="se">\\</span><span class="s">)&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_datatype_json_value</span><span class="p">(</span><span class="n">json_value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">json_value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">unicode</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">json_value</span> <span class="ow">in</span> <span class="n">_all_primitive_types</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">_all_primitive_types</span><span class="p">[</span><span class="n">json_value</span><span class="p">]()</span>
        <span class="k">elif</span> <span class="n">json_value</span> <span class="o">==</span> <span class="s">u&#39;decimal&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DecimalType</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">_FIXED_DECIMAL</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">json_value</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">_FIXED_DECIMAL</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">json_value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">DecimalType</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Could not parse datatype: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">json_value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tpe</span> <span class="o">=</span> <span class="n">json_value</span><span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tpe</span> <span class="ow">in</span> <span class="n">_all_complex_types</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_all_complex_types</span><span class="p">[</span><span class="n">tpe</span><span class="p">]</span><span class="o">.</span><span class="n">fromJson</span><span class="p">(</span><span class="n">json_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tpe</span> <span class="o">==</span> <span class="s">&#39;udt&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">UserDefinedType</span><span class="o">.</span><span class="n">fromJson</span><span class="p">(</span><span class="n">json_value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;not supported type: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tpe</span><span class="p">)</span>


<span class="c"># Mapping Python types to Spark SQL DataType</span>
<span class="n">_type_mappings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">):</span> <span class="n">NullType</span><span class="p">,</span>
    <span class="nb">bool</span><span class="p">:</span> <span class="n">BooleanType</span><span class="p">,</span>
    <span class="nb">int</span><span class="p">:</span> <span class="n">LongType</span><span class="p">,</span>
    <span class="nb">long</span><span class="p">:</span> <span class="n">LongType</span><span class="p">,</span>
    <span class="nb">float</span><span class="p">:</span> <span class="n">DoubleType</span><span class="p">,</span>
    <span class="nb">str</span><span class="p">:</span> <span class="n">StringType</span><span class="p">,</span>
    <span class="nb">unicode</span><span class="p">:</span> <span class="n">StringType</span><span class="p">,</span>
    <span class="nb">bytearray</span><span class="p">:</span> <span class="n">BinaryType</span><span class="p">,</span>
    <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">:</span> <span class="n">DecimalType</span><span class="p">,</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span> <span class="n">DateType</span><span class="p">,</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span> <span class="n">TimestampType</span><span class="p">,</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">:</span> <span class="n">TimestampType</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_infer_type</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Infer the DataType from obj</span>

<span class="sd">    &gt;&gt;&gt; p = ExamplePoint(1.0, 2.0)</span>
<span class="sd">    &gt;&gt;&gt; _infer_type(p)</span>
<span class="sd">    ExamplePointUDT</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Can not infer type for None&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;__UDT__&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">__UDT__</span>

    <span class="n">dataType</span> <span class="o">=</span> <span class="n">_type_mappings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">dataType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataType</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">MapType</span><span class="p">(</span><span class="n">_infer_type</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">_infer_type</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MapType</span><span class="p">(</span><span class="n">NullType</span><span class="p">(),</span> <span class="n">NullType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">array</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">_infer_type</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">NullType</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_infer_schema</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;not supported type: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_infer_schema</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Infer the schema from dict/namedtuple/object&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;_fields&quot;</span><span class="p">):</span>  <span class="c"># namedtuple</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;__FIELDS__&quot;</span><span class="p">):</span>  <span class="c"># Row</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">__FIELDS__</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">row</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Can&#39;t infer schema from tuple&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s">&quot;__dict__&quot;</span><span class="p">):</span>  <span class="c"># object</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Can not infer schema for type: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">StructField</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">_infer_type</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="bp">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">StructType</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_need_python_to_sql_conversion</span><span class="p">(</span><span class="n">dataType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks whether we need python to sql conversion for the given type.</span>
<span class="sd">    For now, only UDTs need this conversion.</span>

<span class="sd">    &gt;&gt;&gt; _need_python_to_sql_conversion(DoubleType())</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; schema0 = StructType([StructField(&quot;indices&quot;, ArrayType(IntegerType(), False), False),</span>
<span class="sd">    ...                       StructField(&quot;values&quot;, ArrayType(DoubleType(), False), False)])</span>
<span class="sd">    &gt;&gt;&gt; _need_python_to_sql_conversion(schema0)</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; _need_python_to_sql_conversion(ExamplePointUDT())</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; schema1 = ArrayType(ExamplePointUDT(), False)</span>
<span class="sd">    &gt;&gt;&gt; _need_python_to_sql_conversion(schema1)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; schema2 = StructType([StructField(&quot;label&quot;, DoubleType(), False),</span>
<span class="sd">    ...                       StructField(&quot;point&quot;, ExamplePointUDT(), False)])</span>
<span class="sd">    &gt;&gt;&gt; _need_python_to_sql_conversion(schema2)</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">([</span><span class="n">_need_python_to_sql_conversion</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">dataType</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dataType</span><span class="o">.</span><span class="n">fields</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_need_python_to_sql_conversion</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">elementType</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">MapType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_need_python_to_sql_conversion</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">keyType</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="n">_need_python_to_sql_conversion</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">valueType</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">UserDefinedType</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">_python_to_sql_converter</span><span class="p">(</span><span class="n">dataType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a converter that converts a Python object into a SQL datum for the given type.</span>

<span class="sd">    &gt;&gt;&gt; conv = _python_to_sql_converter(DoubleType())</span>
<span class="sd">    &gt;&gt;&gt; conv(1.0)</span>
<span class="sd">    1.0</span>
<span class="sd">    &gt;&gt;&gt; conv = _python_to_sql_converter(ArrayType(DoubleType(), False))</span>
<span class="sd">    &gt;&gt;&gt; conv([1.0, 2.0])</span>
<span class="sd">    [1.0, 2.0]</span>
<span class="sd">    &gt;&gt;&gt; conv = _python_to_sql_converter(ExamplePointUDT())</span>
<span class="sd">    &gt;&gt;&gt; conv(ExamplePoint(1.0, 2.0))</span>
<span class="sd">    [1.0, 2.0]</span>
<span class="sd">    &gt;&gt;&gt; schema = StructType([StructField(&quot;label&quot;, DoubleType(), False),</span>
<span class="sd">    ...                      StructField(&quot;point&quot;, ExamplePointUDT(), False)])</span>
<span class="sd">    &gt;&gt;&gt; conv = _python_to_sql_converter(schema)</span>
<span class="sd">    &gt;&gt;&gt; conv((1.0, ExamplePoint(1.0, 2.0)))</span>
<span class="sd">    (1.0, [1.0, 2.0])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_need_python_to_sql_conversion</span><span class="p">(</span><span class="n">dataType</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
        <span class="n">names</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dataType</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dataType</span><span class="o">.</span><span class="n">fields</span><span class="p">])</span>
        <span class="n">converters</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">_python_to_sql_converter</span><span class="p">,</span> <span class="n">types</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">converter</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">converters</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&quot;_fields&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&quot;__FIELDS__&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">converters</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">):</span>  <span class="c"># k-v pairs</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">converters</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">converters</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Unexpected tuple </span><span class="si">%r</span><span class="s"> with type </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dataType</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">converter</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="n">element_converter</span> <span class="o">=</span> <span class="n">_python_to_sql_converter</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">elementType</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="p">[</span><span class="n">element_converter</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">MapType</span><span class="p">):</span>
        <span class="n">key_converter</span> <span class="o">=</span> <span class="n">_python_to_sql_converter</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">keyType</span><span class="p">)</span>
        <span class="n">value_converter</span> <span class="o">=</span> <span class="n">_python_to_sql_converter</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">valueType</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">key_converter</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">value_converter</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">UserDefinedType</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="n">dataType</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Unexpected type </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dataType</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_has_nulltype</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return whether there is NullType in `dt` or not &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">_has_nulltype</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">dataType</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dt</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_has_nulltype</span><span class="p">((</span><span class="n">dt</span><span class="o">.</span><span class="n">elementType</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">MapType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_has_nulltype</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">keyType</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_has_nulltype</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">valueType</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">NullType</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_merge_type</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">NullType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">NullType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="c"># TODO: type cast (such as int -&gt; long)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Can not merge type </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>

    <span class="c"># same type</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
        <span class="n">nfs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dataType</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">StructField</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_merge_type</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">dataType</span><span class="p">,</span> <span class="n">nfs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">NullType</span><span class="p">())))</span>
                  <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">fields</span><span class="p">]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nfs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">StructField</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nfs</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">StructType</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">_merge_type</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">elementType</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">elementType</span><span class="p">),</span> <span class="bp">True</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">MapType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MapType</span><span class="p">(</span><span class="n">_merge_type</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">keyType</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">keyType</span><span class="p">),</span>
                       <span class="n">_merge_type</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">valueType</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">valueType</span><span class="p">),</span>
                       <span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">_need_converter</span><span class="p">(</span><span class="n">dataType</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_need_converter</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">elementType</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">MapType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_need_converter</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">keyType</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_need_converter</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">valueType</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">NullType</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">_create_converter</span><span class="p">(</span><span class="n">dataType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create an converter to drop the names of fields in obj &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_need_converter</span><span class="p">(</span><span class="n">dataType</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">_create_converter</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">elementType</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">map</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">MapType</span><span class="p">):</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">_create_converter</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">valueType</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">conv</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">NullType</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">None</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>

    <span class="c"># dataType must be StructType</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dataType</span><span class="o">.</span><span class="n">fields</span><span class="p">]</span>
    <span class="n">converters</span> <span class="o">=</span> <span class="p">[</span><span class="n">_create_converter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">dataType</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dataType</span><span class="o">.</span><span class="n">fields</span><span class="p">]</span>
    <span class="n">convert_fields</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">_need_converter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">dataType</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dataType</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">convert_struct</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&quot;fields&quot;</span><span class="p">):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&quot;__FIELDS__&quot;</span><span class="p">):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__FIELDS__</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;unexpected tuple: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&quot;__dict__&quot;</span><span class="p">):</span>  <span class="c"># object</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Unexpected obj: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">convert_fields</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">conv</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">conv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">converters</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">convert_struct</span>


<span class="n">_BRACKETS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;(&#39;</span><span class="p">:</span> <span class="s">&#39;)&#39;</span><span class="p">,</span> <span class="s">&#39;[&#39;</span><span class="p">:</span> <span class="s">&#39;]&#39;</span><span class="p">,</span> <span class="s">&#39;{&#39;</span><span class="p">:</span> <span class="s">&#39;}&#39;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">_split_schema_abstract</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    split the schema abstract into fields</span>

<span class="sd">    &gt;&gt;&gt; _split_schema_abstract(&quot;a b  c&quot;)</span>
<span class="sd">    [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]</span>
<span class="sd">    &gt;&gt;&gt; _split_schema_abstract(&quot;a(a b)&quot;)</span>
<span class="sd">    [&#39;a(a b)&#39;]</span>
<span class="sd">    &gt;&gt;&gt; _split_schema_abstract(&quot;a b[] c{a b}&quot;)</span>
<span class="sd">    [&#39;a&#39;, &#39;b[]&#39;, &#39;c{a b}&#39;]</span>
<span class="sd">    &gt;&gt;&gt; _split_schema_abstract(&quot; &quot;)</span>
<span class="sd">    []</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">brackets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39; &#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">brackets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">w</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_BRACKETS</span><span class="p">:</span>
                <span class="n">brackets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_BRACKETS</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">brackets</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">_BRACKETS</span><span class="p">[</span><span class="n">brackets</span><span class="o">.</span><span class="n">pop</span><span class="p">()]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;unexpected &quot;</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">brackets</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;brackets not closed: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">brackets</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">w</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span>


<span class="k">def</span> <span class="nf">_parse_field_abstract</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a field in schema abstract</span>

<span class="sd">    &gt;&gt;&gt; _parse_field_abstract(&quot;a&quot;)</span>
<span class="sd">    StructField(a,None,true)</span>
<span class="sd">    &gt;&gt;&gt; _parse_field_abstract(&quot;b(c d)&quot;)</span>
<span class="sd">    StructField(b,StructType(...c,None,true),StructField(d...</span>
<span class="sd">    &gt;&gt;&gt; _parse_field_abstract(&quot;a[]&quot;)</span>
<span class="sd">    StructField(a,ArrayType(None,true),true)</span>
<span class="sd">    &gt;&gt;&gt; _parse_field_abstract(&quot;a{[]}&quot;)</span>
<span class="sd">    StructField(a,MapType(None,ArrayType(None,true),true),true)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">_BRACKETS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_BRACKETS</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">))</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">StructField</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_parse_schema_abstract</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">idx</span><span class="p">:]),</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">StructField</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_schema_abstract</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    parse abstract into schema</span>

<span class="sd">    &gt;&gt;&gt; _parse_schema_abstract(&quot;a b  c&quot;)</span>
<span class="sd">    StructType...a...b...c...</span>
<span class="sd">    &gt;&gt;&gt; _parse_schema_abstract(&quot;a[b c] b{}&quot;)</span>
<span class="sd">    StructType...a,ArrayType...b...c...b,MapType...</span>
<span class="sd">    &gt;&gt;&gt; _parse_schema_abstract(&quot;c{} d{a b}&quot;)</span>
<span class="sd">    StructType...c,MapType...d,MapType...a...b...</span>
<span class="sd">    &gt;&gt;&gt; _parse_schema_abstract(&quot;a b(t)&quot;).fields[1]</span>
<span class="sd">    StructField(b,StructType(List(StructField(t,None,true))),true)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_parse_schema_abstract</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">_parse_schema_abstract</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="bp">True</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MapType</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">_parse_schema_abstract</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">parts</span> <span class="o">=</span> <span class="n">_split_schema_abstract</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">_parse_field_abstract</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">StructType</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_infer_schema_type</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dataType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fill the dataType with types infered from obj</span>

<span class="sd">    &gt;&gt;&gt; schema = _parse_schema_abstract(&quot;a b c d&quot;)</span>
<span class="sd">    &gt;&gt;&gt; row = (1, 1.0, &quot;str&quot;, datetime.date(2014, 10, 10))</span>
<span class="sd">    &gt;&gt;&gt; _infer_schema_type(row, schema)</span>
<span class="sd">    StructType...LongType...DoubleType...StringType...DateType...</span>
<span class="sd">    &gt;&gt;&gt; row = [[1], {&quot;key&quot;: (1, 2.0)}]</span>
<span class="sd">    &gt;&gt;&gt; schema = _parse_schema_abstract(&quot;a[] b{c d}&quot;)</span>
<span class="sd">    &gt;&gt;&gt; _infer_schema_type(row, schema)</span>
<span class="sd">    StructType...a,ArrayType...b,MapType(StringType,...c,LongType...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dataType</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_infer_type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">NullType</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="n">eType</span> <span class="o">=</span> <span class="n">_infer_schema_type</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dataType</span><span class="o">.</span><span class="n">elementType</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">eType</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">MapType</span><span class="p">):</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">MapType</span><span class="p">(</span><span class="n">_infer_type</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                       <span class="n">_infer_schema_type</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dataType</span><span class="o">.</span><span class="n">valueType</span><span class="p">))</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">dataType</span><span class="o">.</span><span class="n">fields</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> \
            <span class="s">&quot;Obj(</span><span class="si">%s</span><span class="s">) have different length with fields(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">StructField</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_infer_schema_type</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dataType</span><span class="p">),</span> <span class="bp">True</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fs</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">StructType</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Unexpected dataType: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dataType</span><span class="p">)</span>


<span class="n">_acceptable_types</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">BooleanType</span><span class="p">:</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,),</span>
    <span class="n">ByteType</span><span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">),</span>
    <span class="n">ShortType</span><span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">),</span>
    <span class="n">IntegerType</span><span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">),</span>
    <span class="n">LongType</span><span class="p">:</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">),</span>
    <span class="n">FloatType</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,),</span>
    <span class="n">DoubleType</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,),</span>
    <span class="n">DecimalType</span><span class="p">:</span> <span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">,),</span>
    <span class="n">StringType</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">),</span>
    <span class="n">BinaryType</span><span class="p">:</span> <span class="p">(</span><span class="nb">bytearray</span><span class="p">,),</span>
    <span class="n">DateType</span><span class="p">:</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,),</span>
    <span class="n">TimestampType</span><span class="p">:</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,),</span>
    <span class="n">ArrayType</span><span class="p">:</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">array</span><span class="p">),</span>
    <span class="n">MapType</span><span class="p">:</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,),</span>
    <span class="n">StructType</span><span class="p">:</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_verify_type</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dataType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify the type of obj against dataType, raise an exception if</span>
<span class="sd">    they do not match.</span>

<span class="sd">    &gt;&gt;&gt; _verify_type(None, StructType([]))</span>
<span class="sd">    &gt;&gt;&gt; _verify_type(&quot;&quot;, StringType())</span>
<span class="sd">    &gt;&gt;&gt; _verify_type(0, LongType())</span>
<span class="sd">    &gt;&gt;&gt; _verify_type(range(3), ArrayType(ShortType()))</span>
<span class="sd">    &gt;&gt;&gt; _verify_type(set(), ArrayType(StringType())) # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    TypeError:...</span>
<span class="sd">    &gt;&gt;&gt; _verify_type({}, MapType(StringType(), IntegerType()))</span>
<span class="sd">    &gt;&gt;&gt; _verify_type((), StructType([]))</span>
<span class="sd">    &gt;&gt;&gt; _verify_type([], StructType([]))</span>
<span class="sd">    &gt;&gt;&gt; _verify_type([1], StructType([])) # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    ValueError:...</span>
<span class="sd">    &gt;&gt;&gt; _verify_type(ExamplePoint(1.0, 2.0), ExamplePointUDT())</span>
<span class="sd">    &gt;&gt;&gt; _verify_type([1.0, 2.0], ExamplePointUDT()) # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    ValueError:...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># all objects are nullable</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">UserDefinedType</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;__UDT__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">__UDT__</span> <span class="o">==</span> <span class="n">dataType</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%r</span><span class="s"> is not an instance of type </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dataType</span><span class="p">))</span>
        <span class="n">_verify_type</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">dataType</span><span class="o">.</span><span class="n">sqlType</span><span class="p">())</span>
        <span class="k">return</span>

    <span class="n">_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataType</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">_type</span> <span class="ow">in</span> <span class="n">_acceptable_types</span><span class="p">,</span> <span class="s">&quot;unkown datatype: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dataType</span>

    <span class="c"># subclass of them can not be deserialized in JVM</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_acceptable_types</span><span class="p">[</span><span class="n">_type</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> can not accept object in type </span><span class="si">%s</span><span class="s">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
            <span class="n">_verify_type</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dataType</span><span class="o">.</span><span class="n">elementType</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">MapType</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">_verify_type</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dataType</span><span class="o">.</span><span class="n">keyType</span><span class="p">)</span>
            <span class="n">_verify_type</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dataType</span><span class="o">.</span><span class="n">valueType</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Length of object (</span><span class="si">%d</span><span class="s">) does not match with&quot;</span>
                             <span class="s">&quot;length of fields (</span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">fields</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dataType</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
            <span class="n">_verify_type</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">dataType</span><span class="p">)</span>


<span class="n">_cached_cls</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_restore_object</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Restore object during unpickling. &quot;&quot;&quot;</span>
    <span class="c"># use id(dataType) as key to speed up lookup in dict</span>
    <span class="c"># Because of batched pickling, dataType will be the</span>
    <span class="c"># same object in most cases.</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">dataType</span><span class="p">)</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="n">_cached_cls</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cls</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># use dataType as key to avoid create multiple class</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">_cached_cls</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dataType</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cls</span> <span class="o">=</span> <span class="n">_create_cls</span><span class="p">(</span><span class="n">dataType</span><span class="p">)</span>
            <span class="n">_cached_cls</span><span class="p">[</span><span class="n">dataType</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span>
        <span class="n">_cached_cls</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span>
    <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_object</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create an customized object with class `cls`. &quot;&quot;&quot;</span>
    <span class="c"># datetime.date would be deserialized as datetime.datetime</span>
    <span class="c"># from java type, so we need to set it back.</span>
    <span class="k">if</span> <span class="n">cls</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">v</span>


<span class="k">def</span> <span class="nf">_create_getter</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create a getter for item `i` with schema &quot;&quot;&quot;</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="n">_create_cls</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_create_object</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">getter</span>


<span class="k">def</span> <span class="nf">_has_struct_or_date</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return whether `dt` is or has StructType/DateType in it&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_has_struct_or_date</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">elementType</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">MapType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_has_struct_or_date</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">valueType</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">DateType</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">UserDefinedType</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">_create_properties</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create properties according to fields&quot;&quot;&quot;</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;__&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">keyword</span><span class="o">.</span><span class="n">iskeyword</span><span class="p">(</span><span class="n">name</span><span class="p">)):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;field name </span><span class="si">%s</span><span class="s"> can not be accessed in Python,&quot;</span>
                          <span class="s">&quot;use position to access it instead&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_has_struct_or_date</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">dataType</span><span class="p">):</span>
            <span class="c"># delay creating object until accessing it</span>
            <span class="n">getter</span> <span class="o">=</span> <span class="n">_create_getter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">dataType</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">getter</span> <span class="o">=</span> <span class="n">itemgetter</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ps</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">getter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ps</span>


<span class="k">def</span> <span class="nf">_create_cls</span><span class="p">(</span><span class="n">dataType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an class by dataType</span>

<span class="sd">    The created class is similar to namedtuple, but can have nested schema.</span>

<span class="sd">    &gt;&gt;&gt; schema = _parse_schema_abstract(&quot;a b c&quot;)</span>
<span class="sd">    &gt;&gt;&gt; row = (1, 1.0, &quot;str&quot;)</span>
<span class="sd">    &gt;&gt;&gt; schema = _infer_schema_type(row, schema)</span>
<span class="sd">    &gt;&gt;&gt; obj = _create_cls(schema)(row)</span>
<span class="sd">    &gt;&gt;&gt; import pickle</span>
<span class="sd">    &gt;&gt;&gt; pickle.loads(pickle.dumps(obj))</span>
<span class="sd">    Row(a=1, b=1.0, c=&#39;str&#39;)</span>

<span class="sd">    &gt;&gt;&gt; row = [[1], {&quot;key&quot;: (1, 2.0)}]</span>
<span class="sd">    &gt;&gt;&gt; schema = _parse_schema_abstract(&quot;a[] b{c d}&quot;)</span>
<span class="sd">    &gt;&gt;&gt; schema = _infer_schema_type(row, schema)</span>
<span class="sd">    &gt;&gt;&gt; obj = _create_cls(schema)(row)</span>
<span class="sd">    &gt;&gt;&gt; pickle.loads(pickle.dumps(obj))</span>
<span class="sd">    Row(a=[1], b={&#39;key&#39;: Row(c=1, d=2.0)})</span>
<span class="sd">    &gt;&gt;&gt; pickle.loads(pickle.dumps(obj.a))</span>
<span class="sd">    [1]</span>
<span class="sd">    &gt;&gt;&gt; pickle.loads(pickle.dumps(obj.b))</span>
<span class="sd">    {&#39;key&#39;: Row(c=1, d=2.0)}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">_create_cls</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">elementType</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">List</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">l</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">_create_object</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">List</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">MapType</span><span class="p">):</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">_create_cls</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">valueType</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">Dict</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">_create_object</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">Dict</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">DateType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">UserDefinedType</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">datum</span><span class="p">:</span> <span class="n">dataType</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;unexpected data type: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dataType</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Row</span><span class="p">(</span><span class="nb">tuple</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Row in SchemaRDD &quot;&quot;&quot;</span>
        <span class="n">__DATATYPE__</span> <span class="o">=</span> <span class="n">dataType</span>
        <span class="n">__FIELDS__</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dataType</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">__slots__</span> <span class="o">=</span> <span class="p">()</span>

        <span class="c"># create property for fast access</span>
        <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_create_properties</span><span class="p">(</span><span class="n">dataType</span><span class="o">.</span><span class="n">fields</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">asDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Return as a dict &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__FIELDS__</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c"># call collect __repr__ for nested objects</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">&quot;Row(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">=</span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                                          <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__FIELDS__</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">_restore_object</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__DATATYPE__</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">Row</span>


<div class="viewcode-block" id="SQLContext"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SQLContext">[docs]</a><span class="k">class</span> <span class="nc">SQLContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Main entry point for Spark SQL functionality.</span>

<span class="sd">    A SQLContext can be used create L{SchemaRDD}, register L{SchemaRDD} as</span>
<span class="sd">    tables, execute SQL over tables, cache tables, and read parquet files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparkContext</span><span class="p">,</span> <span class="n">sqlContext</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new SQLContext.</span>

<span class="sd">        :param sparkContext: The SparkContext to wrap.</span>
<span class="sd">        :param sqlContext: An optional JVM Scala SQLContext. If set, we do not instatiate a new</span>
<span class="sd">        SQLContext in the JVM, instead we make all calls to this object.</span>

<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(rdd)</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.inferSchema(srdd) # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">            ...</span>
<span class="sd">        TypeError:...</span>

<span class="sd">        &gt;&gt;&gt; bad_rdd = sc.parallelize([1,2,3])</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.inferSchema(bad_rdd) # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">            ...</span>
<span class="sd">        ValueError:...</span>

<span class="sd">        &gt;&gt;&gt; from datetime import datetime</span>
<span class="sd">        &gt;&gt;&gt; allTypes = sc.parallelize([Row(i=1, s=&quot;string&quot;, d=1.0, l=1L,</span>
<span class="sd">        ...     b=True, list=[1, 2, 3], dict={&quot;s&quot;: 0}, row=Row(a=1),</span>
<span class="sd">        ...     time=datetime(2014, 8, 1, 14, 1, 5))])</span>
<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(allTypes)</span>
<span class="sd">        &gt;&gt;&gt; srdd.registerTempTable(&quot;allTypes&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.sql(&#39;select i+1, d+1, not b, list[1], dict[&quot;s&quot;], time, row.a &#39;</span>
<span class="sd">        ...            &#39;from allTypes where b and i &gt; 0&#39;).collect()</span>
<span class="sd">        [Row(c0=2, c1=2.0, c2=False, c3=2, c4=0...8, 1, 14, 1, 5), a=1)]</span>
<span class="sd">        &gt;&gt;&gt; srdd.map(lambda x: (x.i, x.s, x.d, x.l, x.b, x.time,</span>
<span class="sd">        ...                     x.row.a, x.list)).collect()</span>
<span class="sd">        [(1, u&#39;string&#39;, 1.0, 1, True, ...(2014, 8, 1, 14, 1, 5), 1, [1, 2, 3])]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span> <span class="o">=</span> <span class="n">sparkContext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_jsc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jvm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_jvm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scala_SQLContext</span> <span class="o">=</span> <span class="n">sqlContext</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_ssql_ctx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Accessor for the JVM Spark SQL context.</span>

<span class="sd">        Subclasses can override this property to provide their own</span>
<span class="sd">        JVM Contexts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scala_SQLContext</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scala_SQLContext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jvm</span><span class="o">.</span><span class="n">SQLContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jsc</span><span class="o">.</span><span class="n">sc</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scala_SQLContext</span>

<div class="viewcode-block" id="SQLContext.registerFunction"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SQLContext.registerFunction">[docs]</a>    <span class="k">def</span> <span class="nf">registerFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">returnType</span><span class="o">=</span><span class="n">StringType</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Registers a lambda function as a UDF so it can be used in SQL statements.</span>

<span class="sd">        In addition to a name and the function itself, the return type can be optionally specified.</span>
<span class="sd">        When the return type is not given it default to a string and conversion will automatically</span>
<span class="sd">        be done.  For any other return type, the produced object must match the specified type.</span>

<span class="sd">        &gt;&gt;&gt; sqlCtx.registerFunction(&quot;stringLengthString&quot;, lambda x: len(x))</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.sql(&quot;SELECT stringLengthString(&#39;test&#39;)&quot;).collect()</span>
<span class="sd">        [Row(c0=u&#39;4&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.registerFunction(&quot;stringLengthInt&quot;, lambda x: len(x), IntegerType())</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.sql(&quot;SELECT stringLengthInt(&#39;test&#39;)&quot;).collect()</span>
<span class="sd">        [Row(c0=4)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">it</span><span class="p">:</span> <span class="n">imap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">),</span> <span class="n">it</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                   <span class="n">AutoBatchedSerializer</span><span class="p">(</span><span class="n">PickleSerializer</span><span class="p">()),</span>
                   <span class="n">AutoBatchedSerializer</span><span class="p">(</span><span class="n">PickleSerializer</span><span class="p">()))</span>
        <span class="n">ser</span> <span class="o">=</span> <span class="n">CloudPickleSerializer</span><span class="p">()</span>
        <span class="n">pickled_command</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pickled_command</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">):</span>  <span class="c"># 1M</span>
            <span class="n">broadcast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">pickled_command</span><span class="p">)</span>
            <span class="n">pickled_command</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">broadcast</span><span class="p">)</span>
        <span class="n">broadcast_vars</span> <span class="o">=</span> <span class="n">ListConverter</span><span class="p">()</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">_jbroadcast</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_pickled_broadcast_vars</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_gateway</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_pickled_broadcast_vars</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">MapConverter</span><span class="p">()</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_gateway</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>
        <span class="n">includes</span> <span class="o">=</span> <span class="n">ListConverter</span><span class="p">()</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_python_includes</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_gateway</span><span class="o">.</span><span class="n">_gateway_client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">registerPython</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                      <span class="nb">bytearray</span><span class="p">(</span><span class="n">pickled_command</span><span class="p">),</span>
                                      <span class="n">env</span><span class="p">,</span>
                                      <span class="n">includes</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">pythonExec</span><span class="p">,</span>
                                      <span class="n">broadcast_vars</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_javaAccumulator</span><span class="p">,</span>
                                      <span class="n">returnType</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="SQLContext.inferSchema"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SQLContext.inferSchema">[docs]</a>    <span class="k">def</span> <span class="nf">inferSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdd</span><span class="p">,</span> <span class="n">samplingRatio</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Infer and apply a schema to an RDD of L{Row}.</span>

<span class="sd">        When samplingRatio is specified, the schema is inferred by looking</span>
<span class="sd">        at the types of each row in the sampled dataset. Otherwise, the</span>
<span class="sd">        first 100 rows of the RDD are inspected. Nested collections are</span>
<span class="sd">        supported, which can include array, dict, list, Row, tuple,</span>
<span class="sd">        namedtuple, or object.</span>

<span class="sd">        Each row could be L{pyspark.sql.Row} object or namedtuple or objects.</span>
<span class="sd">        Using top level dicts is deprecated, as dict is used to represent Maps.</span>

<span class="sd">        If a single column has multiple distinct inferred types, it may cause</span>
<span class="sd">        runtime exceptions.</span>

<span class="sd">        &gt;&gt;&gt; rdd = sc.parallelize(</span>
<span class="sd">        ...     [Row(field1=1, field2=&quot;row1&quot;),</span>
<span class="sd">        ...      Row(field1=2, field2=&quot;row2&quot;),</span>
<span class="sd">        ...      Row(field1=3, field2=&quot;row3&quot;)])</span>
<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(rdd)</span>
<span class="sd">        &gt;&gt;&gt; srdd.collect()[0]</span>
<span class="sd">        Row(field1=1, field2=u&#39;row1&#39;)</span>

<span class="sd">        &gt;&gt;&gt; NestedRow = Row(&quot;f1&quot;, &quot;f2&quot;)</span>
<span class="sd">        &gt;&gt;&gt; nestedRdd1 = sc.parallelize([</span>
<span class="sd">        ...     NestedRow(array(&#39;i&#39;, [1, 2]), {&quot;row1&quot;: 1.0}),</span>
<span class="sd">        ...     NestedRow(array(&#39;i&#39;, [2, 3]), {&quot;row2&quot;: 2.0})])</span>
<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(nestedRdd1)</span>
<span class="sd">        &gt;&gt;&gt; srdd.collect()</span>
<span class="sd">        [Row(f1=[1, 2], f2={u&#39;row1&#39;: 1.0}), ..., f2={u&#39;row2&#39;: 2.0})]</span>

<span class="sd">        &gt;&gt;&gt; nestedRdd2 = sc.parallelize([</span>
<span class="sd">        ...     NestedRow([[1, 2], [2, 3]], [1, 2]),</span>
<span class="sd">        ...     NestedRow([[2, 3], [3, 4]], [2, 3])])</span>
<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(nestedRdd2)</span>
<span class="sd">        &gt;&gt;&gt; srdd.collect()</span>
<span class="sd">        [Row(f1=[[1, 2], [2, 3]], f2=[1, 2]), ..., f2=[2, 3])]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="n">SchemaRDD</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Cannot apply schema to SchemaRDD&quot;</span><span class="p">)</span>

        <span class="n">first</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">first</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;The first row in RDD is empty, &quot;</span>
                             <span class="s">&quot;can not infer schema&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Using RDD of dict to inferSchema is deprecated,&quot;</span>
                          <span class="s">&quot;please use pyspark.sql.Row instead&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">samplingRatio</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">_infer_schema</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_has_nulltype</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rdd</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">100</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">schema</span> <span class="o">=</span> <span class="n">_merge_type</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">_infer_schema</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">_has_nulltype</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Some of types cannot be determined by the &quot;</span>
                                  <span class="s">&quot;first 100 rows, please try again with sampling&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">samplingRatio</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">:</span>
                <span class="n">rdd</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">samplingRatio</span><span class="p">))</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_infer_schema</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">_merge_type</span><span class="p">)</span>

        <span class="n">converter</span> <span class="o">=</span> <span class="n">_create_converter</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">converter</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">applySchema</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SQLContext.applySchema"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SQLContext.applySchema">[docs]</a>    <span class="k">def</span> <span class="nf">applySchema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdd</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies the given schema to the given RDD of L{tuple} or L{list}.</span>

<span class="sd">        These tuples or lists can contain complex nested structures like</span>
<span class="sd">        lists, maps or nested rows.</span>

<span class="sd">        The schema should be a StructType.</span>

<span class="sd">        It is important that the schema matches the types of the objects</span>
<span class="sd">        in each row or exceptions could be thrown at runtime.</span>

<span class="sd">        &gt;&gt;&gt; rdd2 = sc.parallelize([(1, &quot;row1&quot;), (2, &quot;row2&quot;), (3, &quot;row3&quot;)])</span>
<span class="sd">        &gt;&gt;&gt; schema = StructType([StructField(&quot;field1&quot;, IntegerType(), False),</span>
<span class="sd">        ...     StructField(&quot;field2&quot;, StringType(), False)])</span>
<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.applySchema(rdd2, schema)</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.registerRDDAsTable(srdd, &quot;table1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd2 = sqlCtx.sql(&quot;SELECT * from table1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd2.collect()</span>
<span class="sd">        [Row(field1=1, field2=u&#39;row1&#39;),..., Row(field1=3, field2=u&#39;row3&#39;)]</span>

<span class="sd">        &gt;&gt;&gt; from datetime import date, datetime</span>
<span class="sd">        &gt;&gt;&gt; rdd = sc.parallelize([(127, -128L, -32768, 32767, 2147483647L, 1.0,</span>
<span class="sd">        ...     date(2010, 1, 1),</span>
<span class="sd">        ...     datetime(2010, 1, 1, 1, 1, 1),</span>
<span class="sd">        ...     {&quot;a&quot;: 1}, (2,), [1, 2, 3], None)])</span>
<span class="sd">        &gt;&gt;&gt; schema = StructType([</span>
<span class="sd">        ...     StructField(&quot;byte1&quot;, ByteType(), False),</span>
<span class="sd">        ...     StructField(&quot;byte2&quot;, ByteType(), False),</span>
<span class="sd">        ...     StructField(&quot;short1&quot;, ShortType(), False),</span>
<span class="sd">        ...     StructField(&quot;short2&quot;, ShortType(), False),</span>
<span class="sd">        ...     StructField(&quot;int&quot;, IntegerType(), False),</span>
<span class="sd">        ...     StructField(&quot;float&quot;, FloatType(), False),</span>
<span class="sd">        ...     StructField(&quot;date&quot;, DateType(), False),</span>
<span class="sd">        ...     StructField(&quot;time&quot;, TimestampType(), False),</span>
<span class="sd">        ...     StructField(&quot;map&quot;,</span>
<span class="sd">        ...         MapType(StringType(), IntegerType(), False), False),</span>
<span class="sd">        ...     StructField(&quot;struct&quot;,</span>
<span class="sd">        ...         StructType([StructField(&quot;b&quot;, ShortType(), False)]), False),</span>
<span class="sd">        ...     StructField(&quot;list&quot;, ArrayType(ByteType(), False), False),</span>
<span class="sd">        ...     StructField(&quot;null&quot;, DoubleType(), True)])</span>
<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.applySchema(rdd, schema)</span>
<span class="sd">        &gt;&gt;&gt; results = srdd.map(</span>
<span class="sd">        ...     lambda x: (x.byte1, x.byte2, x.short1, x.short2, x.int, x.float, x.date,</span>
<span class="sd">        ...         x.time, x.map[&quot;a&quot;], x.struct.b, x.list, x.null))</span>
<span class="sd">        &gt;&gt;&gt; results.collect()[0] # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        (127, -128, -32768, 32767, 2147483647, 1.0, datetime.date(2010, 1, 1),</span>
<span class="sd">             datetime.datetime(2010, 1, 1, 1, 1, 1), 1, 2, [1, 2, 3], None)</span>

<span class="sd">        &gt;&gt;&gt; srdd.registerTempTable(&quot;table2&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.sql(</span>
<span class="sd">        ...   &quot;SELECT byte1 - 1 AS byte1, byte2 + 1 AS byte2, &quot; +</span>
<span class="sd">        ...     &quot;short1 + 1 AS short1, short2 - 1 AS short2, int - 1 AS int, &quot; +</span>
<span class="sd">        ...     &quot;float + 1.5 as float FROM table2&quot;).collect()</span>
<span class="sd">        [Row(byte1=126, byte2=-127, short1=-32767, short2=32766, int=2147483646, float=2.5)]</span>

<span class="sd">        &gt;&gt;&gt; rdd = sc.parallelize([(127, -32768, 1.0,</span>
<span class="sd">        ...     datetime(2010, 1, 1, 1, 1, 1),</span>
<span class="sd">        ...     {&quot;a&quot;: 1}, (2,), [1, 2, 3])])</span>
<span class="sd">        &gt;&gt;&gt; abstract = &quot;byte short float time map{} struct(b) list[]&quot;</span>
<span class="sd">        &gt;&gt;&gt; schema = _parse_schema_abstract(abstract)</span>
<span class="sd">        &gt;&gt;&gt; typedSchema = _infer_schema_type(rdd.first(), schema)</span>
<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.applySchema(rdd, typedSchema)</span>
<span class="sd">        &gt;&gt;&gt; srdd.collect()</span>
<span class="sd">        [Row(byte=127, short=-32768, float=1.0, time=..., list=[1, 2, 3])]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="n">SchemaRDD</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Cannot apply schema to SchemaRDD&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;schema should be StructType&quot;</span><span class="p">)</span>

        <span class="c"># take the first few rows to verify schema</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="c"># Row() cannot been deserialized by Pyrolite</span>
        <span class="k">if</span> <span class="n">rows</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;Row&#39;</span><span class="p">:</span>
            <span class="n">rdd</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">_verify_type</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

        <span class="c"># convert python objects to sql data</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="n">_python_to_sql_converter</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">converter</span><span class="p">)</span>

        <span class="n">jrdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jvm</span><span class="o">.</span><span class="n">SerDeUtil</span><span class="o">.</span><span class="n">toJavaArray</span><span class="p">(</span><span class="n">rdd</span><span class="o">.</span><span class="n">_to_java_object_rdd</span><span class="p">())</span>
        <span class="n">srdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">applySchemaToPythonRDD</span><span class="p">(</span><span class="n">jrdd</span><span class="o">.</span><span class="n">rdd</span><span class="p">(),</span> <span class="n">schema</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">SchemaRDD</span><span class="p">(</span><span class="n">srdd</span><span class="o">.</span><span class="n">toJavaSchemaRDD</span><span class="p">(),</span> <span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SQLContext.registerRDDAsTable"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SQLContext.registerRDDAsTable">[docs]</a>    <span class="k">def</span> <span class="nf">registerRDDAsTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdd</span><span class="p">,</span> <span class="n">tableName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Registers the given RDD as a temporary table in the catalog.</span>

<span class="sd">        Temporary tables exist only during the lifetime of this instance of</span>
<span class="sd">        SQLContext.</span>

<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(rdd)</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.registerRDDAsTable(srdd, &quot;table1&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdd</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">is</span> <span class="n">SchemaRDD</span><span class="p">):</span>
            <span class="n">srdd</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">baseSchemaRDD</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">registerRDDAsTable</span><span class="p">(</span><span class="n">srdd</span><span class="p">,</span> <span class="n">tableName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Can only register SchemaRDD as table&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SQLContext.parquetFile"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SQLContext.parquetFile">[docs]</a>    <span class="k">def</span> <span class="nf">parquetFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads a Parquet file, returning the result as a L{SchemaRDD}.</span>

<span class="sd">        &gt;&gt;&gt; import tempfile, shutil</span>
<span class="sd">        &gt;&gt;&gt; parquetFile = tempfile.mkdtemp()</span>
<span class="sd">        &gt;&gt;&gt; shutil.rmtree(parquetFile)</span>
<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(rdd)</span>
<span class="sd">        &gt;&gt;&gt; srdd.saveAsParquetFile(parquetFile)</span>
<span class="sd">        &gt;&gt;&gt; srdd2 = sqlCtx.parquetFile(parquetFile)</span>
<span class="sd">        &gt;&gt;&gt; sorted(srdd.collect()) == sorted(srdd2.collect())</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jschema_rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">parquetFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">toJavaSchemaRDD</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">SchemaRDD</span><span class="p">(</span><span class="n">jschema_rdd</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SQLContext.jsonFile"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SQLContext.jsonFile">[docs]</a>    <span class="k">def</span> <span class="nf">jsonFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">samplingRatio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads a text file storing one JSON object per line as a</span>
<span class="sd">        L{SchemaRDD}.</span>

<span class="sd">        If the schema is provided, applies the given schema to this</span>
<span class="sd">        JSON dataset.</span>

<span class="sd">        Otherwise, it samples the dataset with ratio `samplingRatio` to</span>
<span class="sd">        determine the schema.</span>

<span class="sd">        &gt;&gt;&gt; import tempfile, shutil</span>
<span class="sd">        &gt;&gt;&gt; jsonFile = tempfile.mkdtemp()</span>
<span class="sd">        &gt;&gt;&gt; shutil.rmtree(jsonFile)</span>
<span class="sd">        &gt;&gt;&gt; ofn = open(jsonFile, &#39;w&#39;)</span>
<span class="sd">        &gt;&gt;&gt; for json in jsonStrings:</span>
<span class="sd">        ...   print&gt;&gt;ofn, json</span>
<span class="sd">        &gt;&gt;&gt; ofn.close()</span>
<span class="sd">        &gt;&gt;&gt; srdd1 = sqlCtx.jsonFile(jsonFile)</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.registerRDDAsTable(srdd1, &quot;table1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd2 = sqlCtx.sql(</span>
<span class="sd">        ...   &quot;SELECT field1 AS f1, field2 as f2, field3 as f3, &quot;</span>
<span class="sd">        ...   &quot;field6 as f4 from table1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for r in srdd2.collect():</span>
<span class="sd">        ...     print r</span>
<span class="sd">        Row(f1=1, f2=u&#39;row1&#39;, f3=Row(field4=11, field5=None), f4=None)</span>
<span class="sd">        Row(f1=2, f2=None, f3=Row(field4=22,..., f4=[Row(field7=u&#39;row2&#39;)])</span>
<span class="sd">        Row(f1=None, f2=u&#39;row3&#39;, f3=Row(field4=33, field5=[]), f4=None)</span>

<span class="sd">        &gt;&gt;&gt; srdd3 = sqlCtx.jsonFile(jsonFile, srdd1.schema())</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.registerRDDAsTable(srdd3, &quot;table2&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd4 = sqlCtx.sql(</span>
<span class="sd">        ...   &quot;SELECT field1 AS f1, field2 as f2, field3 as f3, &quot;</span>
<span class="sd">        ...   &quot;field6 as f4 from table2&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for r in srdd4.collect():</span>
<span class="sd">        ...    print r</span>
<span class="sd">        Row(f1=1, f2=u&#39;row1&#39;, f3=Row(field4=11, field5=None), f4=None)</span>
<span class="sd">        Row(f1=2, f2=None, f3=Row(field4=22,..., f4=[Row(field7=u&#39;row2&#39;)])</span>
<span class="sd">        Row(f1=None, f2=u&#39;row3&#39;, f3=Row(field4=33, field5=[]), f4=None)</span>

<span class="sd">        &gt;&gt;&gt; schema = StructType([</span>
<span class="sd">        ...     StructField(&quot;field2&quot;, StringType(), True),</span>
<span class="sd">        ...     StructField(&quot;field3&quot;,</span>
<span class="sd">        ...         StructType([</span>
<span class="sd">        ...             StructField(&quot;field5&quot;,</span>
<span class="sd">        ...                 ArrayType(IntegerType(), False), True)]), False)])</span>
<span class="sd">        &gt;&gt;&gt; srdd5 = sqlCtx.jsonFile(jsonFile, schema)</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.registerRDDAsTable(srdd5, &quot;table3&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd6 = sqlCtx.sql(</span>
<span class="sd">        ...   &quot;SELECT field2 AS f1, field3.field5 as f2, &quot;</span>
<span class="sd">        ...   &quot;field3.field5[0] as f3 from table3&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd6.collect()</span>
<span class="sd">        [Row(f1=u&#39;row1&#39;, f2=None, f3=None)...Row(f1=u&#39;row3&#39;, f2=[], f3=None)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">srdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">jsonFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">samplingRatio</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scala_datatype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">parseDataType</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
            <span class="n">srdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">jsonFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">scala_datatype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SchemaRDD</span><span class="p">(</span><span class="n">srdd</span><span class="o">.</span><span class="n">toJavaSchemaRDD</span><span class="p">(),</span> <span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SQLContext.jsonRDD"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SQLContext.jsonRDD">[docs]</a>    <span class="k">def</span> <span class="nf">jsonRDD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdd</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">samplingRatio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads an RDD storing one JSON object per string as a L{SchemaRDD}.</span>

<span class="sd">        If the schema is provided, applies the given schema to this</span>
<span class="sd">        JSON dataset.</span>

<span class="sd">        Otherwise, it samples the dataset with ratio `samplingRatio` to</span>
<span class="sd">        determine the schema.</span>

<span class="sd">        &gt;&gt;&gt; srdd1 = sqlCtx.jsonRDD(json)</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.registerRDDAsTable(srdd1, &quot;table1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd2 = sqlCtx.sql(</span>
<span class="sd">        ...   &quot;SELECT field1 AS f1, field2 as f2, field3 as f3, &quot;</span>
<span class="sd">        ...   &quot;field6 as f4 from table1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for r in srdd2.collect():</span>
<span class="sd">        ...     print r</span>
<span class="sd">        Row(f1=1, f2=u&#39;row1&#39;, f3=Row(field4=11, field5=None), f4=None)</span>
<span class="sd">        Row(f1=2, f2=None, f3=Row(field4=22..., f4=[Row(field7=u&#39;row2&#39;)])</span>
<span class="sd">        Row(f1=None, f2=u&#39;row3&#39;, f3=Row(field4=33, field5=[]), f4=None)</span>

<span class="sd">        &gt;&gt;&gt; srdd3 = sqlCtx.jsonRDD(json, srdd1.schema())</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.registerRDDAsTable(srdd3, &quot;table2&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd4 = sqlCtx.sql(</span>
<span class="sd">        ...   &quot;SELECT field1 AS f1, field2 as f2, field3 as f3, &quot;</span>
<span class="sd">        ...   &quot;field6 as f4 from table2&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for r in srdd4.collect():</span>
<span class="sd">        ...     print r</span>
<span class="sd">        Row(f1=1, f2=u&#39;row1&#39;, f3=Row(field4=11, field5=None), f4=None)</span>
<span class="sd">        Row(f1=2, f2=None, f3=Row(field4=22..., f4=[Row(field7=u&#39;row2&#39;)])</span>
<span class="sd">        Row(f1=None, f2=u&#39;row3&#39;, f3=Row(field4=33, field5=[]), f4=None)</span>

<span class="sd">        &gt;&gt;&gt; schema = StructType([</span>
<span class="sd">        ...     StructField(&quot;field2&quot;, StringType(), True),</span>
<span class="sd">        ...     StructField(&quot;field3&quot;,</span>
<span class="sd">        ...         StructType([</span>
<span class="sd">        ...             StructField(&quot;field5&quot;,</span>
<span class="sd">        ...                 ArrayType(IntegerType(), False), True)]), False)])</span>
<span class="sd">        &gt;&gt;&gt; srdd5 = sqlCtx.jsonRDD(json, schema)</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.registerRDDAsTable(srdd5, &quot;table3&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd6 = sqlCtx.sql(</span>
<span class="sd">        ...   &quot;SELECT field2 AS f1, field3.field5 as f2, &quot;</span>
<span class="sd">        ...   &quot;field3.field5[0] as f3 from table3&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd6.collect()</span>
<span class="sd">        [Row(f1=u&#39;row1&#39;, f2=None,...Row(f1=u&#39;row3&#39;, f2=[], f3=None)]</span>

<span class="sd">        &gt;&gt;&gt; sqlCtx.jsonRDD(sc.parallelize([&#39;{}&#39;,</span>
<span class="sd">        ...         &#39;{&quot;key0&quot;: {&quot;key1&quot;: &quot;value1&quot;}}&#39;])).collect()</span>
<span class="sd">        [Row(key0=None), Row(key0=Row(key1=u&#39;value1&#39;))]</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.jsonRDD(sc.parallelize([&#39;{&quot;key0&quot;: null}&#39;,</span>
<span class="sd">        ...         &#39;{&quot;key0&quot;: {&quot;key1&quot;: &quot;value1&quot;}}&#39;])).collect()</span>
<span class="sd">        [Row(key0=None), Row(key0=Row(key1=u&#39;value1&#39;))]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">x</span>
        <span class="n">keyed</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">mapPartitions</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">keyed</span><span class="o">.</span><span class="n">_bypass_serializer</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">jrdd</span> <span class="o">=</span> <span class="n">keyed</span><span class="o">.</span><span class="n">_jrdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jvm</span><span class="o">.</span><span class="n">BytesToString</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">srdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">jsonRDD</span><span class="p">(</span><span class="n">jrdd</span><span class="o">.</span><span class="n">rdd</span><span class="p">(),</span> <span class="n">samplingRatio</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scala_datatype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">parseDataType</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
            <span class="n">srdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">jsonRDD</span><span class="p">(</span><span class="n">jrdd</span><span class="o">.</span><span class="n">rdd</span><span class="p">(),</span> <span class="n">scala_datatype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SchemaRDD</span><span class="p">(</span><span class="n">srdd</span><span class="o">.</span><span class="n">toJavaSchemaRDD</span><span class="p">(),</span> <span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SQLContext.sql"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SQLContext.sql">[docs]</a>    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqlQuery</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a L{SchemaRDD} representing the result of the given query.</span>

<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(rdd)</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.registerRDDAsTable(srdd, &quot;table1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd2 = sqlCtx.sql(&quot;SELECT field1 AS f1, field2 as f2 from table1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd2.collect()</span>
<span class="sd">        [Row(f1=1, f2=u&#39;row1&#39;), Row(f1=2, f2=u&#39;row2&#39;), Row(f1=3, f2=u&#39;row3&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SchemaRDD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">sqlQuery</span><span class="p">)</span><span class="o">.</span><span class="n">toJavaSchemaRDD</span><span class="p">(),</span> <span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SQLContext.table"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SQLContext.table">[docs]</a>    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tableName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the specified table as a L{SchemaRDD}.</span>

<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(rdd)</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.registerRDDAsTable(srdd, &quot;table1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd2 = sqlCtx.table(&quot;table1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sorted(srdd.collect()) == sorted(srdd2.collect())</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SchemaRDD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">tableName</span><span class="p">)</span><span class="o">.</span><span class="n">toJavaSchemaRDD</span><span class="p">(),</span> <span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SQLContext.cacheTable"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SQLContext.cacheTable">[docs]</a>    <span class="k">def</span> <span class="nf">cacheTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tableName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Caches the specified table in-memory.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">cacheTable</span><span class="p">(</span><span class="n">tableName</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SQLContext.uncacheTable"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SQLContext.uncacheTable">[docs]</a>    <span class="k">def</span> <span class="nf">uncacheTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tableName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes the specified table from the in-memory cache.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">uncacheTable</span><span class="p">(</span><span class="n">tableName</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="HiveContext"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.HiveContext">[docs]</a><span class="k">class</span> <span class="nc">HiveContext</span><span class="p">(</span><span class="n">SQLContext</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A variant of Spark SQL that integrates with data stored in Hive.</span>

<span class="sd">    Configuration for Hive is read from hive-site.xml on the classpath.</span>
<span class="sd">    It supports running both SQL and HiveQL commands.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparkContext</span><span class="p">,</span> <span class="n">hiveContext</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new HiveContext.</span>

<span class="sd">        :param sparkContext: The SparkContext to wrap.</span>
<span class="sd">        :param hiveContext: An optional JVM Scala HiveContext. If set, we do not instatiate a new</span>
<span class="sd">        HiveContext in the JVM, instead we make all calls to this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">SQLContext</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparkContext</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hiveContext</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scala_HiveContext</span> <span class="o">=</span> <span class="n">hiveContext</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_ssql_ctx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_scala_HiveContext&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scala_HiveContext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hive_ctx</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scala_HiveContext</span>
        <span class="k">except</span> <span class="n">Py4JError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;You must build Spark with Hive. &quot;</span>
                            <span class="s">&quot;Export &#39;SPARK_HIVE=true&#39; and run &quot;</span>
                            <span class="s">&quot;sbt/sbt assembly&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_hive_ctx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jvm</span><span class="o">.</span><span class="n">HiveContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jsc</span><span class="o">.</span><span class="n">sc</span><span class="p">())</span>

<div class="viewcode-block" id="HiveContext.hiveql"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.HiveContext.hiveql">[docs]</a>    <span class="k">def</span> <span class="nf">hiveql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hqlQuery</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DEPRECATED: Use sql()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;hiveql() is deprecated as the sql function now parses using HiveQL by&quot;</span> <span class="o">+</span>
                      <span class="s">&quot;default. The SQL dialect for parsing can be set using &#39;spark.sql.dialect&#39;&quot;</span><span class="p">,</span>
                      <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SchemaRDD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ssql_ctx</span><span class="o">.</span><span class="n">hiveql</span><span class="p">(</span><span class="n">hqlQuery</span><span class="p">)</span><span class="o">.</span><span class="n">toJavaSchemaRDD</span><span class="p">(),</span> <span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HiveContext.hql"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.HiveContext.hql">[docs]</a>    <span class="k">def</span> <span class="nf">hql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hqlQuery</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DEPRECATED: Use sql()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;hql() is deprecated as the sql function now parses using HiveQL by&quot;</span> <span class="o">+</span>
                      <span class="s">&quot;default. The SQL dialect for parsing can be set using &#39;spark.sql.dialect&#39;&quot;</span><span class="p">,</span>
                      <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hiveql</span><span class="p">(</span><span class="n">hqlQuery</span><span class="p">)</span>

</div></div>
<span class="k">class</span> <span class="nc">LocalHiveContext</span><span class="p">(</span><span class="n">HiveContext</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparkContext</span><span class="p">,</span> <span class="n">sqlContext</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">HiveContext</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparkContext</span><span class="p">,</span> <span class="n">sqlContext</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;LocalHiveContext is deprecated. &quot;</span>
                      <span class="s">&quot;Use HiveContext instead.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_hive_ctx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jvm</span><span class="o">.</span><span class="n">LocalHiveContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jsc</span><span class="o">.</span><span class="n">sc</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">TestHiveContext</span><span class="p">(</span><span class="n">HiveContext</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_get_hive_ctx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jvm</span><span class="o">.</span><span class="n">TestHiveContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jsc</span><span class="o">.</span><span class="n">sc</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">_create_row</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">Row</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">)</span>
    <span class="n">row</span><span class="o">.</span><span class="n">__FIELDS__</span> <span class="o">=</span> <span class="n">fields</span>
    <span class="k">return</span> <span class="n">row</span>


<div class="viewcode-block" id="Row"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.Row">[docs]</a><span class="k">class</span> <span class="nc">Row</span><span class="p">(</span><span class="nb">tuple</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A row in L{SchemaRDD}. The fields in it can be accessed like attributes.</span>

<span class="sd">    Row can be used to create a row object by using named arguments,</span>
<span class="sd">    the fields will be sorted by names.</span>

<span class="sd">    &gt;&gt;&gt; row = Row(name=&quot;Alice&quot;, age=11)</span>
<span class="sd">    &gt;&gt;&gt; row</span>
<span class="sd">    Row(age=11, name=&#39;Alice&#39;)</span>
<span class="sd">    &gt;&gt;&gt; row.name, row.age</span>
<span class="sd">    (&#39;Alice&#39;, 11)</span>

<span class="sd">    Row also can be used to create another Row like class, then it</span>
<span class="sd">    could be used to create Row objects, such as</span>

<span class="sd">    &gt;&gt;&gt; Person = Row(&quot;name&quot;, &quot;age&quot;)</span>
<span class="sd">    &gt;&gt;&gt; Person</span>
<span class="sd">    &lt;Row(name, age)&gt;</span>
<span class="sd">    &gt;&gt;&gt; Person(&quot;Alice&quot;, 11)</span>
<span class="sd">    Row(name=&#39;Alice&#39;, age=11)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Can not use both args &quot;</span>
                             <span class="s">&quot;and kwargs to create Row&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="c"># create row class or objects</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c"># create row objects</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="nb">tuple</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
            <span class="n">row</span><span class="o">.</span><span class="n">__FIELDS__</span> <span class="o">=</span> <span class="n">names</span>
            <span class="k">return</span> <span class="n">row</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;No args or kwargs&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Row.asDict"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.Row.asDict">[docs]</a>    <span class="k">def</span> <span class="nf">asDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return as an dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;__FIELDS__&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Cannot convert a Row class into dict&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__FIELDS__</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>

    <span class="c"># let obect acs like class</span></div>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;create new Row object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_create_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;__&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># it will be slow when it has many fields,</span>
            <span class="c"># but this will not be used in normal cases</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__FIELDS__</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;__FIELDS__&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">_create_row</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__FIELDS__</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="o">.</span><span class="n">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;__FIELDS__&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;Row(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">=</span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                                         <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__FIELDS__</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&lt;Row(</span><span class="si">%s</span><span class="s">)&gt;&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">inherit_doc</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c"># only inherit docstring for public functions</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="o">.</span><span class="n">__doc__</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">__bases__</span><span class="p">:</span>
                <span class="n">parent_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parent_func</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parent_func</span><span class="p">,</span> <span class="s">&quot;__doc__&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
                    <span class="n">func</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">parent_func</span><span class="o">.</span><span class="n">__doc__</span>
                    <span class="k">break</span>
    <span class="k">return</span> <span class="n">cls</span>


<span class="nd">@inherit_doc</span>
<div class="viewcode-block" id="SchemaRDD"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD">[docs]</a><span class="k">class</span> <span class="nc">SchemaRDD</span><span class="p">(</span><span class="n">RDD</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;An RDD of L{Row} objects that has an associated schema.</span>

<span class="sd">    The underlying JVM object is a SchemaRDD, not a PythonRDD, so we can</span>
<span class="sd">    utilize the relational query api exposed by Spark SQL.</span>

<span class="sd">    For normal L{pyspark.rdd.RDD} operations (map, count, etc.) the</span>
<span class="sd">    L{SchemaRDD} is not operated on directly, as it&#39;s underlying</span>
<span class="sd">    implementation is an RDD composed of Java objects. Instead it is</span>
<span class="sd">    converted to a PythonRDD in the JVM, on which Python operations can</span>
<span class="sd">    be done.</span>

<span class="sd">    This class receives raw tuples from Java but assigns a class to it in</span>
<span class="sd">    all its data-collection methods (mapPartitionsWithIndex, collect, take,</span>
<span class="sd">    etc) so that PySpark sees them as Row objects with named fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jschema_rdd</span><span class="p">,</span> <span class="n">sql_ctx</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_ctx</span> <span class="o">=</span> <span class="n">sql_ctx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span> <span class="o">=</span> <span class="n">sql_ctx</span><span class="o">.</span><span class="n">_sc</span>
        <span class="n">clsName</span> <span class="o">=</span> <span class="n">jschema_rdd</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">clsName</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;JavaSchemaRDD&quot;</span><span class="p">),</span> <span class="s">&quot;jschema_rdd must be JavaSchemaRDD&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span> <span class="o">=</span> <span class="n">jschema_rdd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_cached</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_checkpointed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_ctx</span><span class="o">.</span><span class="n">_sc</span>
        <span class="c"># the _jrdd is created by javaToPython(), serialized by pickle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jrdd_deserializer</span> <span class="o">=</span> <span class="n">AutoBatchedSerializer</span><span class="p">(</span><span class="n">PickleSerializer</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_jrdd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lazy evaluation of PythonRDD object.</span>

<span class="sd">        Only done when a user calls methods defined by the</span>
<span class="sd">        L{pyspark.rdd.RDD} super class (map, filter, etc.).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_lazy_jrdd&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_jrdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">baseSchemaRDD</span><span class="p">()</span><span class="o">.</span><span class="n">javaToPython</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_jrdd</span>

<div class="viewcode-block" id="SchemaRDD.id"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.id">[docs]</a>    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jrdd</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>
</div>
<div class="viewcode-block" id="SchemaRDD.limit"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.limit">[docs]</a>    <span class="k">def</span> <span class="nf">limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Limit the result count to the number specified.</span>

<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(rdd)</span>
<span class="sd">        &gt;&gt;&gt; srdd.limit(2).collect()</span>
<span class="sd">        [Row(field1=1, field2=u&#39;row1&#39;), Row(field1=2, field2=u&#39;row2&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; srdd.limit(0).collect()</span>
<span class="sd">        []</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">baseSchemaRDD</span><span class="p">()</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="o">.</span><span class="n">toJavaSchemaRDD</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">SchemaRDD</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_ctx</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SchemaRDD.toJSON"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.toJSON">[docs]</a>    <span class="k">def</span> <span class="nf">toJSON</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_unicode</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a SchemaRDD into a MappedRDD of JSON documents; one document per row.</span>

<span class="sd">        &gt;&gt;&gt; srdd1 = sqlCtx.jsonRDD(json)</span>
<span class="sd">        &gt;&gt;&gt; sqlCtx.registerRDDAsTable(srdd1, &quot;table1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd2 = sqlCtx.sql( &quot;SELECT * from table1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd2.toJSON().take(1)[0] == &#39;{&quot;field1&quot;:1,&quot;field2&quot;:&quot;row1&quot;,&quot;field3&quot;:{&quot;field4&quot;:11}}&#39;</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; srdd3 = sqlCtx.sql( &quot;SELECT field3.field4 from table1&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd3.toJSON().collect() == [&#39;{&quot;field4&quot;:11}&#39;, &#39;{&quot;field4&quot;:22}&#39;, &#39;{&quot;field4&quot;:33}&#39;]</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">baseSchemaRDD</span><span class="p">()</span><span class="o">.</span><span class="n">toJSON</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">RDD</span><span class="p">(</span><span class="n">rdd</span><span class="o">.</span><span class="n">toJavaRDD</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="p">,</span> <span class="n">UTF8Deserializer</span><span class="p">(</span><span class="n">use_unicode</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="SchemaRDD.saveAsParquetFile"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.saveAsParquetFile">[docs]</a>    <span class="k">def</span> <span class="nf">saveAsParquetFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the contents as a Parquet file, preserving the schema.</span>

<span class="sd">        Files that are written out using this method can be read back in as</span>
<span class="sd">        a SchemaRDD using the L{SQLContext.parquetFile} method.</span>

<span class="sd">        &gt;&gt;&gt; import tempfile, shutil</span>
<span class="sd">        &gt;&gt;&gt; parquetFile = tempfile.mkdtemp()</span>
<span class="sd">        &gt;&gt;&gt; shutil.rmtree(parquetFile)</span>
<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(rdd)</span>
<span class="sd">        &gt;&gt;&gt; srdd.saveAsParquetFile(parquetFile)</span>
<span class="sd">        &gt;&gt;&gt; srdd2 = sqlCtx.parquetFile(parquetFile)</span>
<span class="sd">        &gt;&gt;&gt; sorted(srdd2.collect()) == sorted(srdd.collect())</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">saveAsParquetFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SchemaRDD.registerTempTable"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.registerTempTable">[docs]</a>    <span class="k">def</span> <span class="nf">registerTempTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Registers this RDD as a temporary table using the given name.</span>

<span class="sd">        The lifetime of this temporary table is tied to the L{SQLContext}</span>
<span class="sd">        that was used to create this SchemaRDD.</span>

<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(rdd)</span>
<span class="sd">        &gt;&gt;&gt; srdd.registerTempTable(&quot;test&quot;)</span>
<span class="sd">        &gt;&gt;&gt; srdd2 = sqlCtx.sql(&quot;select * from test&quot;)</span>
<span class="sd">        &gt;&gt;&gt; sorted(srdd.collect()) == sorted(srdd2.collect())</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">registerTempTable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SchemaRDD.registerAsTable"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.registerAsTable">[docs]</a>    <span class="k">def</span> <span class="nf">registerAsTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DEPRECATED: use registerTempTable() instead&quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Use registerTempTable instead of registerAsTable.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerTempTable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SchemaRDD.insertInto"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.insertInto">[docs]</a>    <span class="k">def</span> <span class="nf">insertInto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tableName</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inserts the contents of this SchemaRDD into the specified table.</span>

<span class="sd">        Optionally overwriting any existing data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">insertInto</span><span class="p">(</span><span class="n">tableName</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SchemaRDD.saveAsTable"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.saveAsTable">[docs]</a>    <span class="k">def</span> <span class="nf">saveAsTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tableName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a new table with the contents of this SchemaRDD.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="n">tableName</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SchemaRDD.schema"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.schema">[docs]</a>    <span class="k">def</span> <span class="nf">schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the schema of this SchemaRDD (represented by</span>
<span class="sd">        a L{StructType}).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_parse_datatype_json_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">baseSchemaRDD</span><span class="p">()</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="SchemaRDD.schemaString"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.schemaString">[docs]</a>    <span class="k">def</span> <span class="nf">schemaString</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the output schema in the tree format.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">schemaString</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SchemaRDD.printSchema"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.printSchema">[docs]</a>    <span class="k">def</span> <span class="nf">printSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints out the schema in the tree format.&quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">schemaString</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SchemaRDD.count"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of elements in this RDD.</span>

<span class="sd">        Unlike the base RDD implementation of count, this implementation</span>
<span class="sd">        leverages the query optimizer to compute the count on the SchemaRDD,</span>
<span class="sd">        which supports features such as filter pushdown.</span>

<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(rdd)</span>
<span class="sd">        &gt;&gt;&gt; srdd.count()</span>
<span class="sd">        3L</span>
<span class="sd">        &gt;&gt;&gt; srdd.count() == srdd.map(lambda x: x).count()</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SchemaRDD.collect"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list that contains all of the rows in this RDD.</span>

<span class="sd">        Each object in the list is a Row, the fields can be accessed as</span>
<span class="sd">        attributes.</span>

<span class="sd">        Unlike the base RDD implementation of collect, this implementation</span>
<span class="sd">        leverages the query optimizer to perform a collect on the SchemaRDD,</span>
<span class="sd">        which supports features such as filter pushdown.</span>

<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(rdd)</span>
<span class="sd">        &gt;&gt;&gt; srdd.collect()</span>
<span class="sd">        [Row(field1=1, field2=u&#39;row1&#39;), ..., Row(field1=3, field2=u&#39;row3&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">SCCallSiteSync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="k">as</span> <span class="n">css</span><span class="p">:</span>
            <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">baseSchemaRDD</span><span class="p">()</span><span class="o">.</span><span class="n">javaToPython</span><span class="p">()</span><span class="o">.</span><span class="n">rdd</span><span class="p">()</span>
            <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">_jvm</span><span class="o">.</span><span class="n">PythonRDD</span><span class="o">.</span><span class="n">collectAndServe</span><span class="p">(</span><span class="n">rdd</span><span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_load_from_socket</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">BatchedSerializer</span><span class="p">(</span><span class="n">PickleSerializer</span><span class="p">())))</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">_create_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">cls</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rs</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="SchemaRDD.take"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.take">[docs]</a>    <span class="k">def</span> <span class="nf">take</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Take the first num rows of the RDD.</span>

<span class="sd">        Each object in the list is a Row, the fields can be accessed as</span>
<span class="sd">        attributes.</span>

<span class="sd">        Unlike the base RDD implementation of take, this implementation</span>
<span class="sd">        leverages the query optimizer to perform a collect on a SchemaRDD,</span>
<span class="sd">        which supports features such as filter pushdown.</span>

<span class="sd">        &gt;&gt;&gt; srdd = sqlCtx.inferSchema(rdd)</span>
<span class="sd">        &gt;&gt;&gt; srdd.take(2)</span>
<span class="sd">        [Row(field1=1, field2=u&#39;row1&#39;), Row(field1=2, field2=u&#39;row2&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">num</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c"># Convert each object in the RDD to a Row with the right class</span>
    <span class="c"># for this SchemaRDD, so that fields can be accessed as attributes.</span></div>
<div class="viewcode-block" id="SchemaRDD.mapPartitionsWithIndex"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.mapPartitionsWithIndex">[docs]</a>    <span class="k">def</span> <span class="nf">mapPartitionsWithIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">preservesPartitioning</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a new RDD by applying a function to each partition of this RDD,</span>
<span class="sd">        while tracking the index of the original partition.</span>

<span class="sd">        &gt;&gt;&gt; rdd = sc.parallelize([1, 2, 3, 4], 4)</span>
<span class="sd">        &gt;&gt;&gt; def f(splitIndex, iterator): yield splitIndex</span>
<span class="sd">        &gt;&gt;&gt; rdd.mapPartitionsWithIndex(f).sum()</span>
<span class="sd">        6</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="n">RDD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jrdd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jrdd_deserializer</span><span class="p">)</span>

        <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">applySchema</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
            <span class="n">cls</span> <span class="o">=</span> <span class="n">_create_cls</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span>

        <span class="n">objrdd</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">mapPartitionsWithIndex</span><span class="p">(</span><span class="n">applySchema</span><span class="p">,</span> <span class="n">preservesPartitioning</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">objrdd</span><span class="o">.</span><span class="n">mapPartitionsWithIndex</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">preservesPartitioning</span><span class="p">)</span>

    <span class="c"># We override the default cache/persist/checkpoint behavior</span>
    <span class="c"># as we want to cache the underlying SchemaRDD object in the JVM,</span>
    <span class="c"># not the PythonRDD checkpointed by the super class</span></div>
<div class="viewcode-block" id="SchemaRDD.cache"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.cache">[docs]</a>    <span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_cached</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="SchemaRDD.persist"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.persist">[docs]</a>    <span class="k">def</span> <span class="nf">persist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storageLevel</span><span class="o">=</span><span class="n">StorageLevel</span><span class="o">.</span><span class="n">MEMORY_ONLY_SER</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_cached</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">javaStorageLevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">_getJavaStorageLevel</span><span class="p">(</span><span class="n">storageLevel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">javaStorageLevel</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="SchemaRDD.unpersist"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.unpersist">[docs]</a>    <span class="k">def</span> <span class="nf">unpersist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_cached</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">unpersist</span><span class="p">(</span><span class="n">blocking</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="SchemaRDD.checkpoint"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.checkpoint">[docs]</a>    <span class="k">def</span> <span class="nf">checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_checkpointed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SchemaRDD.isCheckpointed"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.isCheckpointed">[docs]</a>    <span class="k">def</span> <span class="nf">isCheckpointed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">isCheckpointed</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SchemaRDD.getCheckpointFile"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.getCheckpointFile">[docs]</a>    <span class="k">def</span> <span class="nf">getCheckpointFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">checkpointFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">getCheckpointFile</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">checkpointFile</span><span class="o">.</span><span class="n">isPresent</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">checkpointFile</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="SchemaRDD.coalesce"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.coalesce">[docs]</a>    <span class="k">def</span> <span class="nf">coalesce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numPartitions</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">numPartitions</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SchemaRDD</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_ctx</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SchemaRDD.distinct"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.distinct">[docs]</a>    <span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numPartitions</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">numPartitions</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">numPartitions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SchemaRDD</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_ctx</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SchemaRDD.intersection"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.intersection">[docs]</a>    <span class="k">def</span> <span class="nf">intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">is</span> <span class="n">SchemaRDD</span><span class="p">):</span>
            <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">SchemaRDD</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_ctx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Can only intersect with another SchemaRDD&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SchemaRDD.repartition"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.repartition">[docs]</a>    <span class="k">def</span> <span class="nf">repartition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numPartitions</span><span class="p">):</span>
        <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="n">numPartitions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SchemaRDD</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_ctx</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SchemaRDD.subtract"><a class="viewcode-back" href="../../pyspark.sql.html#pyspark.sql.SchemaRDD.subtract">[docs]</a>    <span class="k">def</span> <span class="nf">subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">numPartitions</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">is</span> <span class="n">SchemaRDD</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">numPartitions</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_jschema_rdd</span><span class="p">,</span>
                                                 <span class="n">numPartitions</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">SchemaRDD</span><span class="p">(</span><span class="n">rdd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_ctx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Can only subtract another SchemaRDD&quot;</span><span class="p">)</span>

</div></div>
<span class="k">def</span> <span class="nf">_test</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="kn">from</span> <span class="nn">pyspark.context</span> <span class="kn">import</span> <span class="n">SparkContext</span>
    <span class="c"># let doctest run in pyspark.sql, so DataTypes can be picklable</span>
    <span class="kn">import</span> <span class="nn">pyspark.sql</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Row</span><span class="p">,</span> <span class="n">SQLContext</span>
    <span class="kn">from</span> <span class="nn">pyspark.tests</span> <span class="kn">import</span> <span class="n">ExamplePoint</span><span class="p">,</span> <span class="n">ExamplePointUDT</span>
    <span class="n">globs</span> <span class="o">=</span> <span class="n">pyspark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">SparkContext</span><span class="p">(</span><span class="s">&#39;local[4]&#39;</span><span class="p">,</span> <span class="s">&#39;PythonTest&#39;</span><span class="p">)</span>
    <span class="n">globs</span><span class="p">[</span><span class="s">&#39;sc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc</span>
    <span class="n">globs</span><span class="p">[</span><span class="s">&#39;sqlCtx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SQLContext</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
    <span class="n">globs</span><span class="p">[</span><span class="s">&#39;rdd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span>
        <span class="p">[</span><span class="n">Row</span><span class="p">(</span><span class="n">field1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">field2</span><span class="o">=</span><span class="s">&quot;row1&quot;</span><span class="p">),</span>
         <span class="n">Row</span><span class="p">(</span><span class="n">field1</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">field2</span><span class="o">=</span><span class="s">&quot;row2&quot;</span><span class="p">),</span>
         <span class="n">Row</span><span class="p">(</span><span class="n">field1</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">field2</span><span class="o">=</span><span class="s">&quot;row3&quot;</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">globs</span><span class="p">[</span><span class="s">&#39;ExamplePoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExamplePoint</span>
    <span class="n">globs</span><span class="p">[</span><span class="s">&#39;ExamplePointUDT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExamplePointUDT</span>
    <span class="n">jsonStrings</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&#39;{&quot;field1&quot;: 1, &quot;field2&quot;: &quot;row1&quot;, &quot;field3&quot;:{&quot;field4&quot;:11}}&#39;</span><span class="p">,</span>
        <span class="s">&#39;{&quot;field1&quot; : 2, &quot;field3&quot;:{&quot;field4&quot;:22, &quot;field5&quot;: [10, 11]},&#39;</span>
        <span class="s">&#39;&quot;field6&quot;:[{&quot;field7&quot;: &quot;row2&quot;}]}&#39;</span><span class="p">,</span>
        <span class="s">&#39;{&quot;field1&quot; : null, &quot;field2&quot;: &quot;row3&quot;, &#39;</span>
        <span class="s">&#39;&quot;field3&quot;:{&quot;field4&quot;:33, &quot;field5&quot;: []}}&#39;</span>
    <span class="p">]</span>
    <span class="n">globs</span><span class="p">[</span><span class="s">&#39;jsonStrings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsonStrings</span>
    <span class="n">globs</span><span class="p">[</span><span class="s">&#39;json&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span><span class="n">jsonStrings</span><span class="p">)</span>
    <span class="p">(</span><span class="n">failure_count</span><span class="p">,</span> <span class="n">test_count</span><span class="p">)</span> <span class="o">=</span> <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span>
        <span class="n">pyspark</span><span class="o">.</span><span class="n">sql</span><span class="p">,</span> <span class="n">globs</span><span class="o">=</span><span class="n">globs</span><span class="p">,</span> <span class="n">optionflags</span><span class="o">=</span><span class="n">doctest</span><span class="o">.</span><span class="n">ELLIPSIS</span><span class="p">)</span>
    <span class="n">globs</span><span class="p">[</span><span class="s">&#39;sc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">failure_count</span><span class="p">:</span>
        <span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">_test</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/spark-logo-hd.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li><a href="../../index.html">PySpark 1.2-SNAPSHOT documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../pyspark.html" >pyspark</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Author.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>